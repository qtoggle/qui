<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: icons/multi-state-sprites-icon.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: icons/multi-state-sprites-icon.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
import $ from '$qui/lib/jquery.module.js'

import * as Theme       from '$qui/theme.js'
import * as ArrayUtils  from '$qui/utils/array.js'
import * as Colors      from '$qui/utils/colors.js'
import * as CSS         from '$qui/utils/css.js'
import {asap}           from '$qui/utils/misc.js'
import * as ObjectUtils from '$qui/utils/object.js'
import * as Window      from '$qui/window.js'

import Icon from './icon.js'


/**
 * @typedef {Object} qui.icons.MultiStateSpritesIcon.StateDetails
 * @property {Number} offsetX the X offset of the icon in the sprites image
 * @property {Number} offsetY the Y offset of the icon in the sprites image
 * @property {String} filter a CSS filter to apply to the icon
 */

/**
 * An icon with different settings for various states.
 *
 * Defined icon states are `normal`, `active`, `focused` and `selected`.
 *
 * @alias qui.icons.MultiStateSpritesIcon
 * @extends qui.icons.Icon
 */
class MultiStateSpritesIcon extends Icon {

    /**
     * @constructs
     * @param {String} url the URL of the image resource
     * @param {Number} bgWidth the total width of the image resource
     * @param {Number} bgHeight the total height of the image resource
     * @param {Number} [size] the size of the icon; defaults to `1`
     * @param {String} [unit] the CSS unit used for all dimension attributes; defaults to `"rem"`
     * @param {Object&lt;String,qui.icons.MultiStateSpritesIcon.StateDetails>} [states] a mapping with icon states
     * @param {Number} [scale] icon scaling factor; defaults to `1`
     * @param {String} [decoration] icon decoration
     */
    constructor({url, bgWidth, bgHeight, size = 1, unit = 'rem', states = null, scale = 1, decoration = null}) {
        super()

        this._url = url
        this._bgWidth = bgWidth
        this._bgHeight = bgHeight
        this._size = size
        this._unit = unit

        this._states = states
        this._scale = scale
        this._decoration = decoration
    }

    /**
     * Tell if the icon has a given state.
     * @param {String} state
     * @returns {Boolean}
     */
    hasState(state) {
        return state in this._states
    }

    _prepareParams() {
        let m, u, v
        let size = this._size
        let bgWidth = String(this._bgWidth)
        let bgHeight = String(this._bgHeight)

        /* Perform required scaling transformations */
        if (this._scale !== 1) {
            size *= this._scale

            m = bgWidth.match(new RegExp('[^\\d]'))
            if (m) {
                u = bgWidth.substring(m.index)
                v = parseInt(bgWidth)
            }
            else {
                u = this._unit
                v = Number(bgWidth) || 0
            }
            bgWidth = v * this._scale + u

            m = bgHeight.match(new RegExp('[^\\d]'))
            if (m) {
                u = bgHeight.substring(m.index)
                v = parseInt(bgHeight)
            }
            else {
                u = this._unit
                v = Number(bgHeight) || 0
            }

            bgHeight = v * this._scale + u
        }

        return {
            size: size,
            bgWidth: bgWidth,
            bgHeight: bgHeight
        }
    }

    _applyTo(element, simple) {
        let params = this._prepareParams()

        let size = params.size
        let bgWidth = params.bgWidth
        let bgHeight = params.bgHeight

        /* Find and remove existing icon state elements */
        let existingStateElements = element.children().filter(function () {
            return this.className.split(' ').some(function (c) {
                return c.match(new RegExp('^qui-icon-[\\w\\-]+$')) &amp;&amp; c !== 'qui-icon-decoration'
            })
        })

        asap(function () {
            existingStateElements.addClass('qui-icon-hidden')
        })

        Theme.afterTransition(function () {
            existingStateElements.remove()
        }, existingStateElements)

        element.addClass('qui-icon')

        /* Add new icon state elements */
        let newElements = $()
        ObjectUtils.forEach(this._states, function (state, details) {

            let offsetX = details.offsetX
            let offsetY = details.offsetY

            /* Incomplete states don't get an element */
            if (offsetX == null || offsetY == null) {
                return
            }

            let stateDiv = $('&lt;div>&lt;/div>', {class: `qui-icon-${state}`})
            /* If no existing elements, display the new element directly, w/o any effect */
            if (existingStateElements.length) {
                stateDiv.addClass('qui-icon-hidden')
            }

            let css = {
                'background-image': `url("${this._url}")`,
                'background-position': `${(-offsetX * size)}${this._unit} ${(-offsetY * size)}${this._unit}`
            }
            if (bgWidth &amp;&amp; bgHeight) {
                css['background-size'] = `${bgWidth} ${bgHeight}`
            }

            if (details.filter) {
                css['filter'] = details.filter
            }

            stateDiv.css(css)

            element.append(stateDiv)
            newElements = newElements.add(stateDiv)

        }, this)

        if (existingStateElements.length) {
            asap(function () {
                newElements.removeClass('qui-icon-hidden')
            })
        }

        let topState = 'normal'
        this.constructor.KNOWN_STATES.forEach(function (state) {
            if (state in this._states) {
                topState = state
            }
        }, this)

        element.removeClass(this.constructor.KNOWN_STATES.map(s => `top-${s}`).join(' '))
        element.addClass(`top-${topState}`)

        /* Decoration */

        let decorationDiv = element.children('div.qui-icon-decoration')
        if (!decorationDiv.length) {
            decorationDiv = null
        }

        if (!decorationDiv &amp;&amp; this._decoration) {
            decorationDiv = $('&lt;div>&lt;/div>', {class: 'qui-icon-decoration'})
            element.prepend(decorationDiv)
        }
        else if (decorationDiv &amp;&amp; !this._decoration) {
            decorationDiv.remove()
            decorationDiv = null
        }

        if (decorationDiv) {
            let css = {
                background: this._decoration
            }

            let bgColor = this._findBgColor(element)
            let bgRGB = Colors.str2rgba(bgColor)
            let decoRGB = Colors.str2rgba(this._decoration)
            if (Colors.contrast(bgRGB, decoRGB) > 1.5) {
                css['border-color'] = bgColor
            }
            else {
                this._findIconColor(element).then(function (color) {
                    css['border-color'] = color
                })
            }

            decorationDiv.css(css)
        }
    }

    _findBgColor(elem) {
        /* Find the background color behind the icon */

        let e = elem
        let bgColor = null
        while (e.length &amp;&amp; e[0].tagName &amp;&amp; (!bgColor || bgColor === 'rgba(0, 0, 0, 0)' ||
                                             bgColor === 'transparent')) {

            bgColor = e.css('background-color')
            e = e.parent()
        }

        if (!e.length || !e[0].tagName) {
            /* Icon element not added yet to the DOM, or no element has a background color */
            bgColor = Theme.getVar('background-color')
        }

        return bgColor
    }

    _findIconColor(elem) {
        /* Find the dominant color of the icon, using a canvas element */

        return new Promise(function (resolve) {
            let params = this._prepareParams()

            let size = params.size
            let pxFactor = 1
            if (this._unit === 'em') {
                if (Window.$body.has(elem).length) {
                    pxFactor = CSS.em2px(1, elem)
                }
                else {
                    pxFactor = CSS.em2px(1)
                }
            }
            else if (this._unit === 'rem') {
                pxFactor = CSS.em2px(1)
            }

            let normalState = this._states['normal']
            let offsetX = 0
            let offsetY = 0
            if (normalState) {
                offsetX = normalState.offsetX || 0
                offsetY = normalState.offsetY || 0
            }

            offsetX *= size
            offsetY *= size

            let canvas = document.createElement('canvas')
            let context = canvas.getContext('2d')

            let width = size * pxFactor

            canvas.width = width
            canvas.height = width /* Yes, width */

            context.scale(this._scale, this._scale)
            context.translate(-offsetX * pxFactor, -offsetY * pxFactor)

            let img = new window.Image()
            img.onload = function () {

                context.drawImage(img, 0, 0)
                let snapshot = context.getImageData(0, 0, width, width)

                function getColor(x, y) {
                    let p = (y * width + x)
                    let r = snapshot.data[4 * p]
                    let g = snapshot.data[4 * p + 1]
                    let b = snapshot.data[4 * p + 2]

                    return Colors.rgba2str([r, g, b])
                }

                let bgColor = getColor(0, 0)
                let colorDict = {}

                for (let y = 0; y &lt; width; y++) {
                    for (let x = 0; x &lt; width; x++) {
                        let color = getColor(x, y)
                        if (color in colorDict) {
                            colorDict[color] += 1
                        }
                        else {
                            colorDict[color] = 0
                        }
                    }
                }

                let colorCounters = ArrayUtils.sortKey(Object.entries(colorDict), c => c[1], /* desc = */ true)
                while (colorCounters[0][0] === bgColor &amp;&amp; colorCounters.length > 1) {
                    colorCounters.shift()
                }

                resolve(colorCounters[0][0])
            }

            img.src = this._url
        }.bind(this))
    }

}


// TODO es7 class fields
MultiStateSpritesIcon.KNOWN_STATES = ['normal', 'active', 'focused', 'selected']


export default MultiStateSpritesIcon
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="qui.html">qui</a></li><li><a href="qui.base.html">base</a></li><li><a href="qui.base.errors.html">errors</a></li><li><a href="qui.base.i18n.html">i18n</a></li><li><a href="qui.base.mixwith.html">mixwith</a></li><li><a href="qui.config.html">config</a></li><li><a href="qui.forms.html">forms</a></li><li><a href="qui.forms.commonfields.html">commonfields</a></li><li><a href="qui.forms.commonforms.html">commonforms</a></li><li><a href="qui.globalglass.html">globalglass</a></li><li><a href="qui.icons.html">icons</a></li><li><a href="qui.icons.defaultstock.html">defaultstock</a></li><li><a href="qui.icons.stocks.html">stocks</a></li><li><a href="qui.lists.commonitems.html">commonitems</a></li><li><a href="qui.lists.commonlists.html">commonlists</a></li><li><a href="qui.mainui.html">mainui</a></li><li><a href="qui.mainui.menubar.html">menubar</a></li><li><a href="qui.mainui.optionsbar.html">optionsbar</a></li><li><a href="qui.mainui.status.html">status</a></li><li><a href="qui.mainui.topbar.html">topbar</a></li><li><a href="qui.messages.html">messages</a></li><li><a href="qui.messages.commonmessageforms.html">commonmessageforms</a></li><li><a href="qui.messages.toast.html">toast</a></li><li><a href="qui.navigation.html">navigation</a></li><li><a href="qui.pages.html">pages</a></li><li><a href="qui.pages.commonpages.html">commonpages</a></li><li><a href="qui.pwa.html">pwa</a></li><li><a href="qui.sections.html">sections</a></li><li><a href="qui.theme.html">theme</a></li><li><a href="qui.utils.html">utils</a></li><li><a href="qui.utils.ajax.html">ajax</a></li><li><a href="qui.utils.array.html">array</a></li><li><a href="qui.utils.colors.html">colors</a></li><li><a href="qui.utils.cookies.html">cookies</a></li><li><a href="qui.utils.crypto.html">crypto</a></li><li><a href="qui.utils.css.html">css</a></li><li><a href="qui.utils.date.html">date</a></li><li><a href="qui.utils.gestures.html">gestures</a></li><li><a href="qui.utils.html.html">html</a></li><li><a href="qui.utils.misc.html">misc</a></li><li><a href="qui.utils.object.html">object</a></li><li><a href="qui.utils.promise.html">promise</a></li><li><a href="qui.utils.string.html">string</a></li><li><a href="qui.views.html">views</a></li><li><a href="qui.views.commonviews.html">commonviews</a></li><li><a href="qui.widgets.html">widgets</a></li><li><a href="qui.window.html">window</a></li></ul><h3>Classes</h3><ul><li><a href="qui.base.ConditionVariable.html">ConditionVariable</a></li><li><a href="qui.base.errors.AssertionError.html">AssertionError</a></li><li><a href="qui.base.errors.NotImplementedError.html">NotImplementedError</a></li><li><a href="qui.base.errors.TimeoutError.html">TimeoutError</a></li><li><a href="qui.base.mixwith.MixinBuilder.html">MixinBuilder</a></li><li><a href="qui.base.Signal.html">Signal</a></li><li><a href="qui.base.SingletonMixin.html">SingletonMixin</a></li><li><a href="qui.base.Timer.html">Timer</a></li><li><a href="qui.forms.commonfields.CheckField.html">CheckField</a></li><li><a href="qui.forms.commonfields.ChoiceButtonsField.html">ChoiceButtonsField</a></li><li><a href="qui.forms.commonfields.ColorComboField.html">ColorComboField</a></li><li><a href="qui.forms.commonfields.ComboField.html">ComboField</a></li><li><a href="qui.forms.commonfields.CompositeField.html">CompositeField</a></li><li><a href="qui.forms.commonfields.EmailField.html">EmailField</a></li><li><a href="qui.forms.commonfields.JQueryUIField.html">JQueryUIField</a></li><li><a href="qui.forms.commonfields.LabelsField.html">LabelsField</a></li><li><a href="qui.forms.commonfields.NumericField.html">NumericField</a></li><li><a href="qui.forms.commonfields.PasswordField.html">PasswordField</a></li><li><a href="qui.forms.commonfields.PhoneField.html">PhoneField</a></li><li><a href="qui.forms.commonfields.ProgressDiskField.html">ProgressDiskField</a></li><li><a href="qui.forms.commonfields.PushButtonField.html">PushButtonField</a></li><li><a href="qui.forms.commonfields.SliderField.html">SliderField</a></li><li><a href="qui.forms.commonfields.TextAreaField.html">TextAreaField</a></li><li><a href="qui.forms.commonfields.TextField.html">TextField</a></li><li><a href="qui.forms.commonfields.UpDownField.html">UpDownField</a></li><li><a href="qui.forms.commonforms.OptionsForm.html">OptionsForm</a></li><li><a href="qui.forms.commonforms.PageForm.html">PageForm</a></li><li><a href="qui.forms.ErrorMapping.html">ErrorMapping</a></li><li><a href="qui.forms.Form.html">Form</a></li><li><a href="qui.forms.FormButton.html">FormButton</a></li><li><a href="qui.forms.FormField.html">FormField</a></li><li><a href="qui.forms.ValidationError.html">ValidationError</a></li><li><a href="qui.icons.Icon.html">Icon</a></li><li><a href="qui.icons.MultiStateSpritesIcon.html">MultiStateSpritesIcon</a></li><li><a href="qui.icons.Stock.html">Stock</a></li><li><a href="qui.icons.StockIcon.html">StockIcon</a></li><li><a href="qui.lists.commonitems.IconLabelListItem.html">IconLabelListItem</a></li><li><a href="qui.lists.List.html">List</a></li><li><a href="qui.lists.ListItem.html">ListItem</a></li><li><a href="qui.lists.PageList.html">PageList</a></li><li><a href="qui.messages.commonmessageforms.ConfirmMessageForm.html">ConfirmMessageForm</a></li><li><a href="qui.messages.commonmessageforms.SimpleMessageForm.html">SimpleMessageForm</a></li><li><a href="qui.messages.commonmessageforms.StickyConfirmMessageForm.html">StickyConfirmMessageForm</a></li><li><a href="qui.messages.commonmessageforms.StickySimpleMessageForm.html">StickySimpleMessageForm</a></li><li><a href="qui.messages.MessageForm.html">MessageForm</a></li><li><a href="qui.messages.StickyModalPageMixin.html">StickyModalPageMixin</a></li><li><a href="qui.messages.StickyModalProgressMessage.html">StickyModalProgressMessage</a></li><li><a href="qui.navigation.PageLoadError.html">PageLoadError</a></li><li><a href="qui.navigation.PageNotFoundError.html">PageNotFoundError</a></li><li><a href="qui.navigation.SectionLoadError.html">SectionLoadError</a></li><li><a href="qui.pages.commonpages.ModalProgressPage.html">ModalProgressPage</a></li><li><a href="qui.pages.commonpages.StructuredPageMixin.html">StructuredPageMixin</a></li><li><a href="qui.pages.PageMixin.html">PageMixin</a></li><li><a href="qui.pages.PagesContext.html">PagesContext</a></li><li><a href="qui.sections.Section.html">Section</a></li><li><a href="qui.utils.crypto.HMACSHA256.html">HMACSHA256</a></li><li><a href="qui.utils.crypto.SHA256.html">SHA256</a></li><li><a href="qui.utils.URL.html">URL</a></li><li><a href="qui.views.commonviews.StructuredViewMixin.html">StructuredViewMixin</a></li><li><a href="qui.views.ViewMixin.html">ViewMixin</a></li></ul><h3>Global</h3><ul><li><a href="global.html#cleanup">cleanup</a></li><li><a href="global.html#getHTML">getHTML</a></li><li><a href="global.html#getServiceWorker">getServiceWorker</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#navigateInitial">navigateInitial</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#sendServiceWorkerMessage">sendServiceWorkerMessage</a></li><li><a href="global.html#serviceWorkerMessageSignal">serviceWorkerMessageSignal</a></li><li><a href="global.html#serviceWorkerReadySignal">serviceWorkerReadySignal</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Wed Apr 08 2020 21:47:32 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
