<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: theme.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: theme.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @namespace qui.theme
 */

import $      from '$qui/lib/jquery.module.js'
import Logger from '$qui/lib/logger.module.js'

import {gettext}         from '$qui/base/i18n.js'
import Signal            from '$qui/base/signal.js'
import Config            from '$qui/config.js'
import * as Colors       from '$qui/utils/colors.js'
import * as CSS          from '$qui/utils/css.js'
import {asap}            from '$qui/utils/misc.js'
import * as ObjectUtils  from '$qui/utils/object.js'
import * as PromiseUtils from '$qui/utils/promise.js'
import * as StringUtils  from '$qui/utils/string.js'
import * as Window       from '$qui/window.js'


const STORAGE_BACKGROUND_COLOR_KEY = 'theme.background-color'

const logger = Logger.get('qui.theme')

let currentTheme = null
let themeVars = null
let transitionDuration = null
let effectsDisabled = null


/**
 * Emitted whenever the theme is changed. Handlers are called with the following parameters:
 *  * `theme: String`, the new theme
 * @alias qui.theme.changeSignal
 */
export const changeSignal = new Signal()


/**
 * Tell the current theme.
 * @alias qui.theme.getCurrent
 * @returns {String}
 */
export function getCurrent() {
    return currentTheme
}

/**
 * Change the theme.
 * @alias qui.theme.setCurrent
 * @param {String} theme
 * @returns {Promise} a promise that resolves as soon as the theme has been set
 */
export function setCurrent(theme) {
    if (currentTheme === theme) {
        return Promise.resolve()
    }

    currentTheme = theme

    logger.debug(`setting theme to ${theme}`)

    if (Window.$body == null) {
        return Promise.resolve() /* Not initialized yet */
    }

    return updateCurrent()
}

function updateCurrent() {
    /* Fade out body */
    Window.$body.css('opacity', '')

    function isLoaded() {
        return CSS.findRules('^br.-theme-name$').some(function (rule) {
            let parts = rule.declaration.split(':', 2)
            if (parts.length &lt; 2) {
                return
            }

            let value = parts[1].split(';')[0].trim()
            value = value.replace(/"/g, '') /* Remove quotation marks */

            return value === currentTheme
        })
    }

    function loadedOrLater() {
        if (isLoaded()) {
            return Promise.resolve()
        }
        else {
            return PromiseUtils.later(10).then(() => loadedOrLater())
        }
    }

    /* Allow 500ms for fading-out */
    return PromiseUtils.later(500).then(function () {

        /* Update disabled attribute of CSS link elements */
        $('link[theme]').each(function () {
            let $link = $(this)
            let linkTheme = $link.attr('theme')
            if (linkTheme === currentTheme) {
                $link.removeAttr('disabled')
            }
            else {
                $link.attr('disabled', '')
            }
        })

        return loadedOrLater().then(function () {

            logger.debug(`theme set to ${currentTheme}`)

            /* Invalidate theme vars */
            themeVars = null

            /* Finally, emit change signal */
            changeSignal.emit(currentTheme)

            /* Consider the theme updated, but allow another 500ms for section soft reload */
            setTimeout(function () {
                Window.$body.css('opacity', '1')
            }, 500)

            /* Set current background color in local storage, to be used at next app reload */
            window.localStorage.setItem(STORAGE_BACKGROUND_COLOR_KEY, getVar('background-color'))
        })

    })
}

/**
 * Return the available themes.
 * @alias qui.theme.getAvailable
 * @returns {Object&lt;String,String>} a dictionary with theme names as keys and display names as values
 */
export function getAvailable() {
    return ObjectUtils.fromEntries(Config.themes.split(',').map(function (theme) {
        return [theme, gettext(StringUtils.title(theme))]
    }))
}

/**
 * Return the value of a theme variable.
 * @alias qui.theme.getVar
 * @param {String} name the variable name
 * @param {String} [def] a default value if the variable is not found or not set
 * @returns {String}
 */
export function getVar(name, def) {
    if (!themeVars) {
        themeVars = {}
        CSS.findRules('^br.-theme-').forEach(function (rule) {
            let name = rule.selector.substring(10)
            let parts = rule.declaration.split(':', 2)
            if (parts.length &lt; 2) {
                return
            }

            themeVars[name] = parts[1].split(';')[0].trim()
        })
    }

    return themeVars[name] || def
}

/**
 * Resolve a color name and normalize it using {@link qui.utils.colors.normalize}.
 *
 * A color name can be an HTML color (e.g. `teal`) or a color theme variable name starting with an `@` (e.g.
 * `@background-color`).
 *
 * If a color is given, it will be normalized and returned right away. If the given color name cannot be resolved, the
 * `@foreground-color` is returned.
 *
 * @alias qui.theme.getColor
 * @param {String} color a color or a color name
 * @returns {String}
 */
export function getColor(color) {
    if (color.startsWith('@')) {
        color = getVar(color.substring(1))
    }

    if (!color) {
        color = getVar('foreground-color')
    }

    return Colors.normalize(color)
}

/**
 * Return the default transition duration, in milliseconds.
 * @alias qui.theme.getTransitionDuration
 * @returns {Number}
 */
export function getTransitionDuration() {
    if (transitionDuration == null) {
        transitionDuration = parseFloat(getVar('transition-duration')) * 1000
    }

    return transitionDuration
}

/**
 * Call a function after a timeout equal to a transition duration,
 * @alias qui.theme.afterTransition
 * @param {Function} func function to run
 * @param {?jQuery} [element] an optional HTML element whose visibility will be tested; if element is not currently
 * visible, `func` will be called asap; if supplied, will be used as `this` argument for `func`
 * @returns {Number} a timeout handle
 */
export function afterTransition(func, element = null) {
    let thisArg = element || window

    if (element &amp;&amp; !element.is(':visible')) {
        return asap(function () {
            func.call(thisArg)
        })
    }

    return setTimeout(function () {
        func.call(thisArg)
    }, getTransitionDuration())
}

/**
 * Create a promise that resolves after a timeout equal to a transition duration,
 * @alias qui.theme.afterTransitionPromise
 * @param {?jQuery} [element] an optional HTML element whose visibility will be tested; if element is not currently
 * visible, promise is resolved asap
 * @returns {Promise}
 */
export function afterTransitionPromise(element = null) {
    return new Promise(function (resolve, reject) {

        if (element &amp;&amp; !element.is(':visible')) {
            resolve()
        }
        else {
            afterTransition(function () {
                resolve()
            }, element)
        }
    })
}

/**
 * Enable transitions, animations, blur filters and other effects. Use this function to re-enable effects disabled by
 * {@link qui.theme.disableEffects}.
 * @alias qui.theme.enableEffects
 */
export function enableEffects() {
    if (!effectsDisabled) {
        return
    }
    effectsDisabled = false
    logger.debug('enabling effects')

    if (Window.$body != null) {
        Window.$body.removeClass('effects-disabled')
    }
}

/**
 * Disable transitions, animations, blur filters and other effects. Use {@link qui.theme.enableEffects} to re-enable
 * effects.
 * @alias qui.theme.disableEffects
 */
export function disableEffects() {
    if (effectsDisabled) {
        return
    }
    effectsDisabled = true
    logger.debug('disabling effects')

    if (Window.$body != null) {
        Window.$body.addClass('effects-disabled')
    }
}


/**
 * Initialize the theme subsystem.
 * @alias qui.theme.init
 * @returns {Promise} a promise that is resolved when theme subsystem has been initialized
 */
export function init() {
    if (effectsDisabled == null) {
        effectsDisabled = Config.defaultEffectsDisabled
    }
    if (currentTheme == null) {
        currentTheme = Config.defaultTheme
    }

    Window.$body.toggleClass('effects-disabled', effectsDisabled)

    return updateCurrent().then(function () {
        /* Normally updateCurrent() will take care of fading in body, adds extra 500ms for section soft reload.
         * This being the first call, we want the body visible as soon as theme is loaded */
        Window.$body.css('opacity', '1')
    })
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="qui.html">qui</a></li><li><a href="qui.base.html">base</a></li><li><a href="qui.base.errors.html">errors</a></li><li><a href="qui.base.i18n.html">i18n</a></li><li><a href="qui.base.mixwith.html">mixwith</a></li><li><a href="qui.config.html">config</a></li><li><a href="qui.forms.html">forms</a></li><li><a href="qui.forms.commonfields.html">commonfields</a></li><li><a href="qui.forms.commonforms.html">commonforms</a></li><li><a href="qui.globalglass.html">globalglass</a></li><li><a href="qui.icons.html">icons</a></li><li><a href="qui.icons.defaultstock.html">defaultstock</a></li><li><a href="qui.icons.stocks.html">stocks</a></li><li><a href="qui.lists.html">lists</a></li><li><a href="qui.lists.commonitems.html">commonitems</a></li><li><a href="qui.lists.commonlists.html">commonlists</a></li><li><a href="qui.mainui.html">mainui</a></li><li><a href="qui.mainui.menubar.html">menubar</a></li><li><a href="qui.mainui.optionsbar.html">optionsbar</a></li><li><a href="qui.mainui.status.html">status</a></li><li><a href="qui.mainui.topbar.html">topbar</a></li><li><a href="qui.messages.html">messages</a></li><li><a href="qui.messages.commonmessageforms.html">commonmessageforms</a></li><li><a href="qui.messages.toast.html">toast</a></li><li><a href="qui.navigation.html">navigation</a></li><li><a href="qui.pages.html">pages</a></li><li><a href="qui.pages.commonpages.html">commonpages</a></li><li><a href="qui.pwa.html">pwa</a></li><li><a href="qui.sections.html">sections</a></li><li><a href="qui.tables.html">tables</a></li><li><a href="qui.tables.commoncells.html">commoncells</a></li><li><a href="qui.tables.commontables.html">commontables</a></li><li><a href="qui.theme.html">theme</a></li><li><a href="qui.utils.html">utils</a></li><li><a href="qui.utils.ajax.html">ajax</a></li><li><a href="qui.utils.array.html">array</a></li><li><a href="qui.utils.colors.html">colors</a></li><li><a href="qui.utils.cookies.html">cookies</a></li><li><a href="qui.utils.crypto.html">crypto</a></li><li><a href="qui.utils.css.html">css</a></li><li><a href="qui.utils.date.html">date</a></li><li><a href="qui.utils.gestures.html">gestures</a></li><li><a href="qui.utils.html.html">html</a></li><li><a href="qui.utils.misc.html">misc</a></li><li><a href="qui.utils.object.html">object</a></li><li><a href="qui.utils.promise.html">promise</a></li><li><a href="qui.utils.string.html">string</a></li><li><a href="qui.views.html">views</a></li><li><a href="qui.views.commonviews.html">commonviews</a></li><li><a href="qui.widgets.html">widgets</a></li><li><a href="qui.window.html">window</a></li></ul><h3>Classes</h3><ul><li><a href="qui.base.ConditionVariable.html">ConditionVariable</a></li><li><a href="qui.base.errors.AssertionError.html">AssertionError</a></li><li><a href="qui.base.errors.CancelledError.html">CancelledError</a></li><li><a href="qui.base.errors.NotImplementedError.html">NotImplementedError</a></li><li><a href="qui.base.errors.TimeoutError.html">TimeoutError</a></li><li><a href="qui.base.mixwith.MixinBuilder.html">MixinBuilder</a></li><li><a href="qui.base.Signal.html">Signal</a></li><li><a href="qui.base.SingletonMixin.html">SingletonMixin</a></li><li><a href="qui.base.Timer.html">Timer</a></li><li><a href="qui.forms.commonfields.CheckField.html">CheckField</a></li><li><a href="qui.forms.commonfields.ChoiceButtonsField.html">ChoiceButtonsField</a></li><li><a href="qui.forms.commonfields.ColorComboField.html">ColorComboField</a></li><li><a href="qui.forms.commonfields.ComboField.html">ComboField</a></li><li><a href="qui.forms.commonfields.CompositeField.html">CompositeField</a></li><li><a href="qui.forms.commonfields.CustomHTMLField.html">CustomHTMLField</a></li><li><a href="qui.forms.commonfields.EmailField.html">EmailField</a></li><li><a href="qui.forms.commonfields.JQueryUIField.html">JQueryUIField</a></li><li><a href="qui.forms.commonfields.LabelsField.html">LabelsField</a></li><li><a href="qui.forms.commonfields.NumericField.html">NumericField</a></li><li><a href="qui.forms.commonfields.PasswordField.html">PasswordField</a></li><li><a href="qui.forms.commonfields.PhoneField.html">PhoneField</a></li><li><a href="qui.forms.commonfields.ProgressDiskField.html">ProgressDiskField</a></li><li><a href="qui.forms.commonfields.PushButtonField.html">PushButtonField</a></li><li><a href="qui.forms.commonfields.SliderField.html">SliderField</a></li><li><a href="qui.forms.commonfields.TextAreaField.html">TextAreaField</a></li><li><a href="qui.forms.commonfields.TextField.html">TextField</a></li><li><a href="qui.forms.commonfields.UpDownField.html">UpDownField</a></li><li><a href="qui.forms.commonforms.OptionsForm.html">OptionsForm</a></li><li><a href="qui.forms.commonforms.PageForm.html">PageForm</a></li><li><a href="qui.forms.ErrorMapping.html">ErrorMapping</a></li><li><a href="qui.forms.Form.html">Form</a></li><li><a href="qui.forms.FormButton.html">FormButton</a></li><li><a href="qui.forms.FormField.html">FormField</a></li><li><a href="qui.forms.ValidationError.html">ValidationError</a></li><li><a href="qui.icons.Icon.html">Icon</a></li><li><a href="qui.icons.MultiStateSpritesIcon.html">MultiStateSpritesIcon</a></li><li><a href="qui.icons.Stock.html">Stock</a></li><li><a href="qui.icons.StockIcon.html">StockIcon</a></li><li><a href="qui.lists.commonitems.IconLabelListItem.html">IconLabelListItem</a></li><li><a href="qui.lists.commonlists.PageList.html">PageList</a></li><li><a href="qui.lists.List.html">List</a></li><li><a href="qui.lists.ListItem.html">ListItem</a></li><li><a href="qui.messages.commonmessageforms.ConfirmMessageForm.html">ConfirmMessageForm</a></li><li><a href="qui.messages.commonmessageforms.SimpleMessageForm.html">SimpleMessageForm</a></li><li><a href="qui.messages.commonmessageforms.StickySimpleMessageForm.html">StickySimpleMessageForm</a></li><li><a href="qui.messages.MessageForm.html">MessageForm</a></li><li><a href="qui.messages.StickyModalPageMixin.html">StickyModalPageMixin</a></li><li><a href="qui.messages.StickyModalProgressMessage.html">StickyModalProgressMessage</a></li><li><a href="qui.navigation.PageLoadError.html">PageLoadError</a></li><li><a href="qui.navigation.PageNotFoundError.html">PageNotFoundError</a></li><li><a href="qui.navigation.SectionLoadError.html">SectionLoadError</a></li><li><a href="qui.pages.commonpages.ModalProgressPage.html">ModalProgressPage</a></li><li><a href="qui.pages.commonpages.StructuredPageMixin.html">StructuredPageMixin</a></li><li><a href="qui.pages.PageMixin.html">PageMixin</a></li><li><a href="qui.pages.PagesContext.html">PagesContext</a></li><li><a href="qui.sections.HideCancelled.html">HideCancelled</a></li><li><a href="qui.sections.Section.html">Section</a></li><li><a href="qui.tables.commoncells.IconLabelTableCell.html">IconLabelTableCell</a></li><li><a href="qui.tables.commoncells.PushButtonTableCell.html">PushButtonTableCell</a></li><li><a href="qui.tables.commoncells.SimpleTableCell.html">SimpleTableCell</a></li><li><a href="qui.tables.commontables.PageTable.html">PageTable</a></li><li><a href="qui.tables.Table.html">Table</a></li><li><a href="qui.tables.TableCell.html">TableCell</a></li><li><a href="qui.tables.TableRow.html">TableRow</a></li><li><a href="qui.utils.crypto.HMACSHA256.html">HMACSHA256</a></li><li><a href="qui.utils.crypto.SHA256.html">SHA256</a></li><li><a href="qui.utils.URL.html">URL</a></li><li><a href="qui.utils.VisibilityManager.html">VisibilityManager</a></li><li><a href="qui.views.commonviews.IconLabelViewMixin.html">IconLabelViewMixin</a></li><li><a href="qui.views.commonviews.ProgressViewMixin.html">ProgressViewMixin</a></li><li><a href="qui.views.commonviews.StructuredViewMixin.html">StructuredViewMixin</a></li><li><a href="qui.views.ViewMixin.html">ViewMixin</a></li></ul><h3>Global</h3><ul><li><a href="global.html#cleanup">cleanup</a></li><li><a href="global.html#getHTML">getHTML</a></li><li><a href="global.html#getServiceWorker">getServiceWorker</a></li><li><a href="global.html#isClass">isClass</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isServiceWorkerSupported">isServiceWorkerSupported</a></li><li><a href="global.html#makeToken">makeToken</a></li><li><a href="global.html#navigateInitial">navigateInitial</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#sendServiceWorkerMessage">sendServiceWorkerMessage</a></li><li><a href="global.html#serviceWorkerMessageSignal">serviceWorkerMessageSignal</a></li><li><a href="global.html#whenServiceWorkerReady">whenServiceWorkerReady</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Mon Jun 01 2020 20:50:21 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
