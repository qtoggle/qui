<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @namespace qui
 */

import * as RequireJSCompat from '$qui/base/require-js-compat.js'
import $                    from '$qui/lib/jquery.module.js'
import Logger               from '$qui/lib/logger.module.js'

import '$qui/lib/jquery-ui.js'
import '$qui/lib/jquery.mousewheel.js'
import '$qui/lib/jquery.longpress.js'
import '$qui/lib/pep.js'

import {globalize}               from '$qui/base/base.js'
import ConditionVariable         from '$qui/base/condition-variable.js'
import {CancelledError}          from '$qui/base/errors.js'
import {gettext}                 from '$qui/base/i18n.js'
import Config                    from '$qui/config.js'
import * as Forms                from '$qui/forms/forms.js'
import * as GlobalGlass          from '$qui/global-glass.js'
import * as Icons                from '$qui/icons/icons.js'
import * as MainUI               from '$qui/main-ui/main-ui.js'
import * as Status               from '$qui/main-ui/status.js'
import {StickySimpleMessageForm} from '$qui/messages/common-message-forms/common-message-forms.js'
import * as Messages             from '$qui/messages/messages.js'
import * as Navigation           from '$qui/navigation.js'
import * as Pages                from '$qui/pages/pages.js'
import * as PWA                  from '$qui/pwa.js'
import * as Sections             from '$qui/sections/sections.js'
import * as Theme                from '$qui/theme.js'
import * as ArrayUtils           from '$qui/utils/array.js'
import * as DateUtils            from '$qui/utils/date.js'
import * as ObjectUtils          from '$qui/utils/object.js'
import * as Widgets              from '$qui/widgets/widgets.js'
import * as Window               from '$qui/window.js'


const logger = Logger.get('qui')

/**
 * A condition that is fulfilled as soon as the app is fully initialized and ready to be used.
 * @alias qui.whenReady
 * @type {qui.base.ConditionVariable}
 */
export let whenReady = new ConditionVariable()


function initConfig() {
    /* Look for the main script name */
    let error = new Error()
    let names = error.stack.match(new RegExp('[A-Za-z0-9_-]+\\.js', 'g'))
    if (!names) {
        throw new Error('Cannot find main script: empty stack')
    }

    let scripts = document.getElementsByTagName('script')

    /* Find the reference to the main app DOM script */
    let mainAppScriptName = names[names.length - 1]
    let mainAppScript = Array.from(scripts).find(s => s.src.split('?')[0].endsWith(mainAppScriptName))
    if (!mainAppScript) {
        throw new Error(`Cannot find main script: no such script ${mainAppScriptName}`)
    }

    /* Deduce app name from main app script name */
    let appName = mainAppScriptName.slice(0, -3) /* remove .js */
    if (appName.endsWith('-bundle')) {
        appName = appName.slice(0, -7)
    }
    if (appName === 'index') { /* development mode */
        appName = 'qui-app'
    }
    Config.appName = appName

    /* Copy all data-* attributes from script tag to Config */
    ObjectUtils.forEach(mainAppScript.dataset, (n, v) => Config.set(n, v))

    /* Find the URL to the QUI index */
    let urls = error.stack.match(/http.*?\.js/gi)
    if (!urls || !urls.length) {
        throw new Error('Cannot find QUI index script: no script URLs found in stack')
    }

    /* Detect QUI static URL - we know it's the first script in stack */
    let quiIndexScript = urls[0]
    let m = quiIndexScript.match(new RegExp('[.a-z0-9_-]+\\.js'))
    if (!m) {
        throw new Error('Cannot find QUI index script: no JS file found in stack')
    }

    Config.quiIndexName = quiIndexScript.split('/').slice(-1)[0]
    Config.quiIndexName = Config.quiIndexName.split(':')[0] /* Remove :row:col */
    Config.quiStaticURL = quiIndexScript.slice(0, m.index - 1)
    /* In debug mode, we have an extra "/js" dir */
    if (Config.debug) {
        Config.quiStaticURL = Config.quiStaticURL.split('/').slice(0, -1).join('/')
    }

    /* Detect app static URL - we know it's the last script in stack */
    let appIndexScript = urls.slice(-1)[0]
    m = appIndexScript.match(new RegExp('[.a-z0-9_-]+\\.js'))

    Config.appIndexName = appIndexScript.split('/').slice(-1)[0]
    Config.appIndexName = Config.appIndexName.split(':')[0] /* Remove :row:col */
    Config.appStaticURL = appIndexScript.slice(0, m.index - 1)
    /* In debug mode, we have an extra "/js" dir */
    if (Config.debug) {
        Config.appStaticURL = Config.appStaticURL.split('/').slice(0, -1).join('/')
    }

    /* Use details supplied by webpack at build time */
    if (window.__quiAppVersion) {
        Config.appCurrentVersion = window.__quiAppVersion
    }
}

function initJQuery() {
    function passivizeEvent(eventName) {
        $.event.special[eventName] = {
            setup: function (_, ns, handle) {
                if (ns.includes('noPreventDefault')) {
                    this.addEventListener(eventName, handle, {passive: false})
                }
                else {
                    this.addEventListener(eventName, handle, {passive: true})
                }
            }
        }
    }

    passivizeEvent('touchstart')
    passivizeEvent('touchmove')
}

function configureLogging() {
    Logger.setHandler(Logger.createDefaultHandler({
        formatter: function (messages, context) {
            messages.unshift(`[${context.name}]`)
            messages.unshift(`${context.level.name}:`)
            messages.unshift(DateUtils.formatPercent(new Date(), '%Y-%m-%d %H:%M:%S:'))
        }
    }))

    Logger.setLevel(Config.debug ? Logger.DEBUG : Logger.INFO)

    /* Inject errorStack logger method */
    Object.getPrototypeOf(logger).errorStack = function (msg, error) {
        this.error(`${msg}: ${error ? error.toString() : '(no error supplied)'}`)
        if (error &amp;&amp; error.stack) {
            this.error(error.stack)
        }
    }

    /* Unlimited stack trace */
    Error.stackTraceLimit = Infinity

    /* Export Logger to global scope  */
    let qui = (window.qui = window.qui || {})
    qui.Logger = Logger
}

function logCurrentConfig() {
    ArrayUtils.sortKey(Object.entries(Config), e => e[0]).forEach(function ([key, value]) {
        if (typeof value === 'function') {
            return
        }

        logger.debug(`using Config.${key} = ${JSON.stringify(value)}`)
    })
}

function configureGlobalErrorHandling() {
    window.addEventListener('unhandledrejection', function (e) {
        /* Uncaught/unhandled cancelled errors are silently ignored */
        if (e.reason instanceof CancelledError) {
            e.preventDefault()
            return
        }

        logger.error(`unhandled promise rejection: ${e.reason || '&lt;unspecified reason>'}`)
        if (e.reason != null) {
            logger.error(e.reason)
        }
        logger.error(e.promise)

        let msg = gettext('An unexpected error occurred.')
        msg += '&lt;br>'
        msg += gettext('Application reloading is recommended.')
        new StickySimpleMessageForm({type: 'error', message: msg}).show()
        e.preventDefault()
    })
}


/**
 * Initialize the QUI library.
 * @alias qui.init
 * @returns {Promise} a promise that resolves when QUI is initialized and ready
 */
export function init() {
    RequireJSCompat.cleanup()
    initConfig()
    initJQuery()
    configureLogging()
    logCurrentConfig()

    return Promise.resolve()
    .then(() => Window.init())
    .then(() => PWA.init())
    .then(() => Theme.init())
    .then(() => Icons.init())
    .then(() => MainUI.init())
    .then(() => Status.init())
    .then(() => Widgets.init())
    .then(() => Messages.init())
    .then(() => GlobalGlass.init())
    .then(() => Sections.init())
    .then(() => Pages.init())
    .then(() => Navigation.init())
    .then(() => Forms.init())
    .then(() => configureGlobalErrorHandling())
    .then(function () {
        whenReady.fulfill()
        logger.debug('QUI is ready')
    })
}

/* Make some modules accessible globally, via window */
import('$qui/config.js').then(globalize('qui.Config'))
import('$qui/lib/logger.module.js').then(globalize('qui.Logger'))
import('$qui/sections/sections.js').then(globalize('qui.sections'))
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="qui.html">qui</a></li><li><a href="qui.base.html">base</a></li><li><a href="qui.base.errors.html">errors</a></li><li><a href="qui.base.i18n.html">i18n</a></li><li><a href="qui.base.mixwith.html">mixwith</a></li><li><a href="qui.config.html">config</a></li><li><a href="qui.forms.html">forms</a></li><li><a href="qui.forms.commonfields.html">commonfields</a></li><li><a href="qui.forms.commonforms.html">commonforms</a></li><li><a href="qui.globalglass.html">globalglass</a></li><li><a href="qui.icons.html">icons</a></li><li><a href="qui.icons.defaultstock.html">defaultstock</a></li><li><a href="qui.icons.stocks.html">stocks</a></li><li><a href="qui.lists.html">lists</a></li><li><a href="qui.lists.commonitems.html">commonitems</a></li><li><a href="qui.lists.commonlists.html">commonlists</a></li><li><a href="qui.mainui.html">mainui</a></li><li><a href="qui.mainui.menubar.html">menubar</a></li><li><a href="qui.mainui.optionsbar.html">optionsbar</a></li><li><a href="qui.mainui.status.html">status</a></li><li><a href="qui.mainui.topbar.html">topbar</a></li><li><a href="qui.messages.html">messages</a></li><li><a href="qui.messages.commonmessageforms.html">commonmessageforms</a></li><li><a href="qui.messages.toast.html">toast</a></li><li><a href="qui.navigation.html">navigation</a></li><li><a href="qui.pages.html">pages</a></li><li><a href="qui.pages.commonpages.html">commonpages</a></li><li><a href="qui.pwa.html">pwa</a></li><li><a href="qui.sections.html">sections</a></li><li><a href="qui.tables.html">tables</a></li><li><a href="qui.tables.commoncells.html">commoncells</a></li><li><a href="qui.tables.commontables.html">commontables</a></li><li><a href="qui.theme.html">theme</a></li><li><a href="qui.utils.html">utils</a></li><li><a href="qui.utils.ajax.html">ajax</a></li><li><a href="qui.utils.array.html">array</a></li><li><a href="qui.utils.colors.html">colors</a></li><li><a href="qui.utils.cookies.html">cookies</a></li><li><a href="qui.utils.crypto.html">crypto</a></li><li><a href="qui.utils.css.html">css</a></li><li><a href="qui.utils.date.html">date</a></li><li><a href="qui.utils.gestures.html">gestures</a></li><li><a href="qui.utils.html.html">html</a></li><li><a href="qui.utils.misc.html">misc</a></li><li><a href="qui.utils.object.html">object</a></li><li><a href="qui.utils.promise.html">promise</a></li><li><a href="qui.utils.string.html">string</a></li><li><a href="qui.views.html">views</a></li><li><a href="qui.views.commonviews.html">commonviews</a></li><li><a href="qui.widgets.html">widgets</a></li><li><a href="qui.window.html">window</a></li></ul><h3>Classes</h3><ul><li><a href="qui.base.ConditionVariable.html">ConditionVariable</a></li><li><a href="qui.base.errors.AssertionError.html">AssertionError</a></li><li><a href="qui.base.errors.CancelledError.html">CancelledError</a></li><li><a href="qui.base.errors.NotImplementedError.html">NotImplementedError</a></li><li><a href="qui.base.errors.TimeoutError.html">TimeoutError</a></li><li><a href="qui.base.mixwith.MixinBuilder.html">MixinBuilder</a></li><li><a href="qui.base.Signal.html">Signal</a></li><li><a href="qui.base.SingletonMixin.html">SingletonMixin</a></li><li><a href="qui.base.Timer.html">Timer</a></li><li><a href="qui.forms.commonfields.CheckField.html">CheckField</a></li><li><a href="qui.forms.commonfields.ChoiceButtonsField.html">ChoiceButtonsField</a></li><li><a href="qui.forms.commonfields.ColorComboField.html">ColorComboField</a></li><li><a href="qui.forms.commonfields.ComboField.html">ComboField</a></li><li><a href="qui.forms.commonfields.CompositeField.html">CompositeField</a></li><li><a href="qui.forms.commonfields.CustomHTMLField.html">CustomHTMLField</a></li><li><a href="qui.forms.commonfields.EmailField.html">EmailField</a></li><li><a href="qui.forms.commonfields.JQueryUIField.html">JQueryUIField</a></li><li><a href="qui.forms.commonfields.LabelsField.html">LabelsField</a></li><li><a href="qui.forms.commonfields.NumericField.html">NumericField</a></li><li><a href="qui.forms.commonfields.PasswordField.html">PasswordField</a></li><li><a href="qui.forms.commonfields.PhoneField.html">PhoneField</a></li><li><a href="qui.forms.commonfields.ProgressDiskField.html">ProgressDiskField</a></li><li><a href="qui.forms.commonfields.PushButtonField.html">PushButtonField</a></li><li><a href="qui.forms.commonfields.SliderField.html">SliderField</a></li><li><a href="qui.forms.commonfields.TextAreaField.html">TextAreaField</a></li><li><a href="qui.forms.commonfields.TextField.html">TextField</a></li><li><a href="qui.forms.commonfields.UpDownField.html">UpDownField</a></li><li><a href="qui.forms.commonforms.OptionsForm.html">OptionsForm</a></li><li><a href="qui.forms.commonforms.PageForm.html">PageForm</a></li><li><a href="qui.forms.ErrorMapping.html">ErrorMapping</a></li><li><a href="qui.forms.Form.html">Form</a></li><li><a href="qui.forms.FormButton.html">FormButton</a></li><li><a href="qui.forms.FormField.html">FormField</a></li><li><a href="qui.forms.ValidationError.html">ValidationError</a></li><li><a href="qui.icons.Icon.html">Icon</a></li><li><a href="qui.icons.MultiStateSpritesIcon.html">MultiStateSpritesIcon</a></li><li><a href="qui.icons.Stock.html">Stock</a></li><li><a href="qui.icons.StockIcon.html">StockIcon</a></li><li><a href="qui.lists.commonitems.IconLabelListItem.html">IconLabelListItem</a></li><li><a href="qui.lists.commonlists.PageList.html">PageList</a></li><li><a href="qui.lists.List.html">List</a></li><li><a href="qui.lists.ListItem.html">ListItem</a></li><li><a href="qui.messages.commonmessageforms.ConfirmMessageForm.html">ConfirmMessageForm</a></li><li><a href="qui.messages.commonmessageforms.SimpleMessageForm.html">SimpleMessageForm</a></li><li><a href="qui.messages.commonmessageforms.StickySimpleMessageForm.html">StickySimpleMessageForm</a></li><li><a href="qui.messages.MessageForm.html">MessageForm</a></li><li><a href="qui.messages.StickyModalPageMixin.html">StickyModalPageMixin</a></li><li><a href="qui.messages.StickyModalProgressMessage.html">StickyModalProgressMessage</a></li><li><a href="qui.navigation.PageLoadError.html">PageLoadError</a></li><li><a href="qui.navigation.PageNotFoundError.html">PageNotFoundError</a></li><li><a href="qui.navigation.SectionLoadError.html">SectionLoadError</a></li><li><a href="qui.pages.commonpages.ModalProgressPage.html">ModalProgressPage</a></li><li><a href="qui.pages.commonpages.StructuredPageMixin.html">StructuredPageMixin</a></li><li><a href="qui.pages.PageMixin.html">PageMixin</a></li><li><a href="qui.pages.PagesContext.html">PagesContext</a></li><li><a href="qui.sections.HideCancelled.html">HideCancelled</a></li><li><a href="qui.sections.Section.html">Section</a></li><li><a href="qui.tables.commoncells.IconLabelTableCell.html">IconLabelTableCell</a></li><li><a href="qui.tables.commoncells.PushButtonTableCell.html">PushButtonTableCell</a></li><li><a href="qui.tables.commoncells.SimpleTableCell.html">SimpleTableCell</a></li><li><a href="qui.tables.commontables.PageTable.html">PageTable</a></li><li><a href="qui.tables.Table.html">Table</a></li><li><a href="qui.tables.TableCell.html">TableCell</a></li><li><a href="qui.tables.TableRow.html">TableRow</a></li><li><a href="qui.utils.crypto.HMACSHA256.html">HMACSHA256</a></li><li><a href="qui.utils.crypto.SHA256.html">SHA256</a></li><li><a href="qui.utils.URL.html">URL</a></li><li><a href="qui.utils.VisibilityManager.html">VisibilityManager</a></li><li><a href="qui.views.commonviews.IconLabelViewMixin.html">IconLabelViewMixin</a></li><li><a href="qui.views.commonviews.ProgressViewMixin.html">ProgressViewMixin</a></li><li><a href="qui.views.commonviews.StructuredViewMixin.html">StructuredViewMixin</a></li><li><a href="qui.views.ViewMixin.html">ViewMixin</a></li></ul><h3>Global</h3><ul><li><a href="global.html#cleanup">cleanup</a></li><li><a href="global.html#getHTML">getHTML</a></li><li><a href="global.html#getServiceWorker">getServiceWorker</a></li><li><a href="global.html#isClass">isClass</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isServiceWorkerSupported">isServiceWorkerSupported</a></li><li><a href="global.html#makeToken">makeToken</a></li><li><a href="global.html#navigateInitial">navigateInitial</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#sendServiceWorkerMessage">sendServiceWorkerMessage</a></li><li><a href="global.html#serviceWorkerMessageSignal">serviceWorkerMessageSignal</a></li><li><a href="global.html#whenServiceWorkerReady">whenServiceWorkerReady</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Thu Jun 18 2020 20:10:14 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
