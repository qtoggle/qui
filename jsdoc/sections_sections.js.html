<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: sections/sections.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: sections/sections.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @namespace qui.sections
 */

import $      from '$qui/lib/jquery.module.js'
import Logger from '$qui/lib/logger.module.js'

import {AssertionError} from '$qui/base/errors.js'
import StockIcon        from '$qui/icons/stock-icon.js'
import * as OptionsBar  from '$qui/main-ui/options-bar.js'
import * as Navigation  from '$qui/navigation.js'
import * as Theme       from '$qui/theme.js'
import * as Window      from '$qui/window.js'


/**
 * @alias qui.sections.BUTTON_TYPE_MENU_BAR
 */
export const BUTTON_TYPE_MENU_BAR = 'menu_bar'

/**
 * @alias qui.sections.BUTTON_TYPE_TOP_BAR
 */
export const BUTTON_TYPE_TOP_BAR = 'top_bar'

/**
 * @alias qui.sections.BUTTON_TYPE_NONE
 */
export const BUTTON_TYPE_NONE = 'none'


const logger = Logger.get('qui.sections')

let sectionClasses = []
let sectionsList = []
let currentSection = null
let homeSection = null


function attachSectionEventRelays() {
    Window.screenLayoutChangeSignal.connect(function (smallScreen, landscape) {
        sectionsList.forEach(function (s) {
            s.onScreenLayoutChange(smallScreen, landscape)
        })
    })

    Window.resizeSignal.connect(function (width, height) {
        sectionsList.forEach(function (s) {
            s.onWindowResize(width, height)
        })
    })

    OptionsBar.openCloseSignal.connect(function (opened) {
        if (!currentSection) {
            return
        }

        currentSection.onOptionsBarOpenClose(opened)
    })
}

/**
 * @private
 * @returns {Promise}
 */
function softReload() {
    logger.debug('soft reloading')

    /* Reset sections */
    if (currentSection) {
        let currentPath = Navigation.getCurrentPath()

        return reset().then(function () {
            return Navigation.navigate(currentPath)
        })
    }

    return Promise.resolve()
}


/**
 * Register a section class.
 * @alias qui.sections.register
 * @param {typeof qui.sections.Section} sectionClass the section class (see {@link qui.sections.Section})
 */
export function register(sectionClass) {
    let index = sectionClasses.indexOf(sectionClass)
    if (index >= 0) {
        throw new AssertionError('Attempt to register a section class that has already been registered')
    }

    sectionClasses.push(sectionClass)

    let section = sectionClass.getInstance()
    section.handleRegister()
    sectionsList.push(section)

    logger.debug(`registered section "${section.getId()}"`)

    if (!homeSection) {
        /* Home section is, by default, the first section */
        logger.debug(`home section set to "${section.getId()}"`)
        homeSection = section
    }
}

/**
 * Unregister a section class.
 * @alias qui.sections.unregister
 * @param {typeof qui.sections.Section} sectionClass the section class (see {@link qui.sections.Section})
 */
export function unregister(sectionClass) {
    let index = sectionClasses.indexOf(sectionClass)
    if (index &lt; 0) {
        throw new AssertionError('Attempt to unregister a section class that has not been registered')
    }

    sectionClasses.splice(index, 1)

    let section = sectionsList[index]
    section.handleUnregister()

    sectionsList.splice(index, 1)
    logger.debug(`unregistered section "${section.getId()}"`)
}

/**
 * Lookup a section by its identifier.
 * @alias qui.sections.get
 * @param {String} id the section identifier
 * @returns {?qui.sections.Section} the section if found, otherwise `null`
 */
export function get(id) {
    return sectionsList.find(section => section.getId() === id) || null
}

/**
 * Return the current section.
 * @alias qui.sections.getCurrent
 * @returns {?qui.sections.Section}
 */
export function getCurrent() {
    return currentSection
}

/**
 * Return all registered sections, in order.
 * @alias qui.sections.all
 * @returns {qui.sections.Section[]}
 */
export function all() {
    return sectionsList.slice()
}

/**
 * Switch to the given section, making it current.
 * @alias qui.sections.switchTo
 * @param {qui.sections.Section} section the section
 * @param {String} [source] optional source to pass to {@link qui.sections.Section#onShow} (defaults to `program`)
 * @returns {Promise} a promise that resolves as soon as the section is loaded.
 */
export function switchTo(section, source) {
    /* If requested section is already the current section, do nothing more */
    if ((currentSection === section)) {
        Navigation.updateHistoryEntry()
        return currentSection.whenLoaded()
    }

    return section.whenPreloaded().then(function () {
        let oldSection = currentSection
        let s = section.navigate([])
        if (s !== section) {
            logger.debug(`section "${section.getId()}" redirected to section "${s.getId()}"`)
            return switchTo(s, source)
        }

        currentSection = section

        if (source === undefined) {
            source = 'program'
        }

        logger.debug(`switching to section "${section.getId()}" (source: ${source})`)

        if (oldSection) {
            oldSection._hide()
        }

        return section._show(source, oldSection).then(function () {
            Navigation.updateHistoryEntry()
        })
    })
}

/**
 * Switch to the home section.
 * @alias qui.sections.showHome
 * @param {?Boolean} [reset] if `true` will reset the home section to its initial state, recreating its main page
 * @returns {Promise} a promise that resolves as soon as the home section is loaded.
 */
export function showHome(reset) {
    if (!homeSection) {
        throw new AssertionError('No home section')
    }

    let promise = Promise.resolve()
    if (reset) {
        promise = homeSection.reset()
    }

    return promise.then(function () {
        return switchTo(homeSection, /* source = */ 'home')
    })
}

/**
 * Set the home section.
 * @alias qui.sections.setHome
 * @param {qui.sections.Section} section the new home section
 */
export function setHome(section) {
    homeSection = section
}

/**
 * Return the home section.
 * @alias qui.sections.getHome
 * @returns {?qui.sections.Section}
 */
export function getHome() {
    return homeSection
}

/**
 * Reset all sections.
 * @returns {Promise} a promise that is settled as soon as all sections have been reset
 */
export function reset() {
    return Promise.all(sectionsList.map(s => s.reset()))
}


export function init() {
    attachSectionEventRelays()

    /* Prevent unwanted section closing when window is closed */
    Window.closeSignal.connect(function () {
        return !sectionsList.some(s => !s.canClose())
    })

    Window.screenLayoutChangeSignal.connect(function (smallScreen, landscape) {
        /* Automatically update top icon buttons according to small screen state */
        $('div.qui-top-bar > div.qui-top-button.qui-section-button > div.qui-icon').each(function () {
            StockIcon.alterElement($(this), {variant: smallScreen ? 'white' : 'interactive'})
        })

        logger.debug('soft reloading due to screen layout change')
        softReload()
    })

    Theme.changeSignal.connect(function (theme) {
        logger.debug('soft reloading due to theme change')
        softReload()
    })

    /* Export some stuff to global scope */
    let qui = (window.qui = window.qui || {})
    qui.getCurrentSection = getCurrent
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="qui.html">qui</a></li><li><a href="qui.base.html">base</a></li><li><a href="qui.base.errors.html">errors</a></li><li><a href="qui.base.i18n.html">i18n</a></li><li><a href="qui.base.mixwith.html">mixwith</a></li><li><a href="qui.config.html">config</a></li><li><a href="qui.forms.html">forms</a></li><li><a href="qui.forms.commonfields.html">commonfields</a></li><li><a href="qui.forms.commonforms.html">commonforms</a></li><li><a href="qui.globalglass.html">globalglass</a></li><li><a href="qui.icons.html">icons</a></li><li><a href="qui.icons.defaultstock.html">defaultstock</a></li><li><a href="qui.icons.stocks.html">stocks</a></li><li><a href="qui.lists.commonitems.html">commonitems</a></li><li><a href="qui.lists.commonlists.html">commonlists</a></li><li><a href="qui.mainui.html">mainui</a></li><li><a href="qui.mainui.menubar.html">menubar</a></li><li><a href="qui.mainui.optionsbar.html">optionsbar</a></li><li><a href="qui.mainui.status.html">status</a></li><li><a href="qui.mainui.topbar.html">topbar</a></li><li><a href="qui.messages.html">messages</a></li><li><a href="qui.messages.commonmessageforms.html">commonmessageforms</a></li><li><a href="qui.messages.toast.html">toast</a></li><li><a href="qui.navigation.html">navigation</a></li><li><a href="qui.pages.html">pages</a></li><li><a href="qui.pages.commonpages.html">commonpages</a></li><li><a href="qui.pwa.html">pwa</a></li><li><a href="qui.sections.html">sections</a></li><li><a href="qui.theme.html">theme</a></li><li><a href="qui.utils.html">utils</a></li><li><a href="qui.utils.ajax.html">ajax</a></li><li><a href="qui.utils.array.html">array</a></li><li><a href="qui.utils.colors.html">colors</a></li><li><a href="qui.utils.cookies.html">cookies</a></li><li><a href="qui.utils.crypto.html">crypto</a></li><li><a href="qui.utils.css.html">css</a></li><li><a href="qui.utils.date.html">date</a></li><li><a href="qui.utils.gestures.html">gestures</a></li><li><a href="qui.utils.html.html">html</a></li><li><a href="qui.utils.misc.html">misc</a></li><li><a href="qui.utils.object.html">object</a></li><li><a href="qui.utils.promise.html">promise</a></li><li><a href="qui.utils.string.html">string</a></li><li><a href="qui.views.html">views</a></li><li><a href="qui.views.commonviews.html">commonviews</a></li><li><a href="qui.widgets.html">widgets</a></li><li><a href="qui.window.html">window</a></li></ul><h3>Classes</h3><ul><li><a href="qui.base.ConditionVariable.html">ConditionVariable</a></li><li><a href="qui.base.errors.AssertionError.html">AssertionError</a></li><li><a href="qui.base.errors.NotImplementedError.html">NotImplementedError</a></li><li><a href="qui.base.errors.TimeoutError.html">TimeoutError</a></li><li><a href="qui.base.mixwith.MixinBuilder.html">MixinBuilder</a></li><li><a href="qui.base.Signal.html">Signal</a></li><li><a href="qui.base.SingletonMixin.html">SingletonMixin</a></li><li><a href="qui.base.Timer.html">Timer</a></li><li><a href="qui.forms.commonfields.CheckField.html">CheckField</a></li><li><a href="qui.forms.commonfields.ChoiceButtonsField.html">ChoiceButtonsField</a></li><li><a href="qui.forms.commonfields.ColorComboField.html">ColorComboField</a></li><li><a href="qui.forms.commonfields.ComboField.html">ComboField</a></li><li><a href="qui.forms.commonfields.CompositeField.html">CompositeField</a></li><li><a href="qui.forms.commonfields.EmailField.html">EmailField</a></li><li><a href="qui.forms.commonfields.JQueryUIField.html">JQueryUIField</a></li><li><a href="qui.forms.commonfields.LabelsField.html">LabelsField</a></li><li><a href="qui.forms.commonfields.NumericField.html">NumericField</a></li><li><a href="qui.forms.commonfields.PasswordField.html">PasswordField</a></li><li><a href="qui.forms.commonfields.PhoneField.html">PhoneField</a></li><li><a href="qui.forms.commonfields.ProgressDiskField.html">ProgressDiskField</a></li><li><a href="qui.forms.commonfields.PushButtonField.html">PushButtonField</a></li><li><a href="qui.forms.commonfields.SliderField.html">SliderField</a></li><li><a href="qui.forms.commonfields.TextAreaField.html">TextAreaField</a></li><li><a href="qui.forms.commonfields.TextField.html">TextField</a></li><li><a href="qui.forms.commonfields.UpDownField.html">UpDownField</a></li><li><a href="qui.forms.commonforms.OptionsForm.html">OptionsForm</a></li><li><a href="qui.forms.commonforms.PageForm.html">PageForm</a></li><li><a href="qui.forms.ErrorMapping.html">ErrorMapping</a></li><li><a href="qui.forms.Form.html">Form</a></li><li><a href="qui.forms.FormButton.html">FormButton</a></li><li><a href="qui.forms.FormField.html">FormField</a></li><li><a href="qui.forms.ValidationError.html">ValidationError</a></li><li><a href="qui.icons.Icon.html">Icon</a></li><li><a href="qui.icons.MultiStateSpritesIcon.html">MultiStateSpritesIcon</a></li><li><a href="qui.icons.Stock.html">Stock</a></li><li><a href="qui.icons.StockIcon.html">StockIcon</a></li><li><a href="qui.lists.commonitems.IconLabelListItem.html">IconLabelListItem</a></li><li><a href="qui.lists.List.html">List</a></li><li><a href="qui.lists.ListItem.html">ListItem</a></li><li><a href="qui.lists.PageList.html">PageList</a></li><li><a href="qui.messages.commonmessageforms.ConfirmMessageForm.html">ConfirmMessageForm</a></li><li><a href="qui.messages.commonmessageforms.SimpleMessageForm.html">SimpleMessageForm</a></li><li><a href="qui.messages.commonmessageforms.StickyConfirmMessageForm.html">StickyConfirmMessageForm</a></li><li><a href="qui.messages.commonmessageforms.StickySimpleMessageForm.html">StickySimpleMessageForm</a></li><li><a href="qui.messages.MessageForm.html">MessageForm</a></li><li><a href="qui.messages.StickyModalPageMixin.html">StickyModalPageMixin</a></li><li><a href="qui.messages.StickyModalProgressMessage.html">StickyModalProgressMessage</a></li><li><a href="qui.navigation.PageLoadError.html">PageLoadError</a></li><li><a href="qui.navigation.PageNotFoundError.html">PageNotFoundError</a></li><li><a href="qui.navigation.SectionLoadError.html">SectionLoadError</a></li><li><a href="qui.pages.commonpages.ModalProgressPage.html">ModalProgressPage</a></li><li><a href="qui.pages.commonpages.StructuredPageMixin.html">StructuredPageMixin</a></li><li><a href="qui.pages.PageMixin.html">PageMixin</a></li><li><a href="qui.pages.PagesContext.html">PagesContext</a></li><li><a href="qui.sections.Section.html">Section</a></li><li><a href="qui.utils.crypto.HMACSHA256.html">HMACSHA256</a></li><li><a href="qui.utils.crypto.SHA256.html">SHA256</a></li><li><a href="qui.utils.URL.html">URL</a></li><li><a href="qui.views.commonviews.StructuredViewMixin.html">StructuredViewMixin</a></li><li><a href="qui.views.ViewMixin.html">ViewMixin</a></li></ul><h3>Global</h3><ul><li><a href="global.html#cleanup">cleanup</a></li><li><a href="global.html#getHTML">getHTML</a></li><li><a href="global.html#getServiceWorker">getServiceWorker</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#navigateInitial">navigateInitial</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#sendServiceWorkerMessage">sendServiceWorkerMessage</a></li><li><a href="global.html#serviceWorkerMessageSignal">serviceWorkerMessageSignal</a></li><li><a href="global.html#serviceWorkerReadySignal">serviceWorkerReadySignal</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Thu Apr 09 2020 18:07:02 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
